name: Monitor Home Assistant Versions

on:
  # å®šæ—¶è§¦å‘ï¼ˆæ¯å¤©æ‰§è¡Œä¸€æ¬¡ï¼‰
  schedule:
    - cron: '0 0 * * *'
  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
  workflow_dispatch:

jobs:
  monitor-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get remote stable.json
        id: get-remote
        run: |
          # è·å–è¿œç¨‹ stable.json æ–‡ä»¶
          REMOTE_URL="https://raw.githubusercontent.com/home-assistant/version/stable.json"
          curl -s -o remote_stable.json "$REMOTE_URL"
          
          # éªŒè¯æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸ
          if [ ! -f "remote_stable.json" ]; then
            echo "Failed to download remote stable.json"
            exit 1
          fi
          
          echo "Remote stable.json downloaded successfully"

      - name: Compare versions
        id: compare
        run: |
          # ç¡®ä¿æœ¬åœ°æ–‡ä»¶å­˜åœ¨
          if [ ! -f "stable.json" ]; then
            echo "Local stable.json not found. Creating a new one..."
            cp remote_stable.json stable.json
            echo "version_updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
          if cmp -s stable.json remote_stable.json; then
            echo "No changes in stable.json"
            echo "version_updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "version_updated=true" >> $GITHUB_OUTPUT
          
          # æå– homeassistant éƒ¨åˆ†çš„å˜æ›´
          LOCAL_HOMEASSISTANT=$(jq '.homeassistant' stable.json)
          REMOTE_HOMEASSISTANT=$(jq '.homeassistant' remote_stable.json)
          
          # åˆ›å»ºå˜æ›´æ‘˜è¦
          echo "change_summary<<EOF" >> $GITHUB_OUTPUT
          echo "## Home Assistant ç‰ˆæœ¬æ›´æ–°\n" >> $GITHUB_OUTPUT
          
          # éå†æ¯ä¸ªå¹³å°ï¼Œæ£€æŸ¥ç‰ˆæœ¬å˜æ›´
          echo "$REMOTE_HOMEASSISTANT" | jq -r 'keys[] as $k | "\($k): \(.[$k])"' | while read -r line; do
            platform=$(echo "$line" | cut -d: -f1)
            new_version=$(echo "$line" | cut -d: -f2 | xargs)
          
            old_version=$(echo "$LOCAL_HOMEASSISTANT" | jq -r ".[\"$platform\"]")
          
            if [ "$old_version" != "$new_version" ]; then
              echo "- **$platform**: $old_version â†’ $new_version" >> $GITHUB_OUTPUT
            fi
          done
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update local file if changed
        if: steps.compare.outputs.version_updated == 'true'
        run: |
          # å¤åˆ¶è¿œç¨‹æ–‡ä»¶åˆ°æœ¬åœ°
          cp remote_stable.json stable.json
          
          # æäº¤æ›´æ–°
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add stable.json
          git commit -m "Update Home Assistant versions from upstream"
          git push
          
          echo "Local stable.json updated and committed"

      - name: Send notification
        if: steps.compare.outputs.version_updated == 'true'
        run: |
          # è®¾ç½®æ—¶åŒºä¸ºä¸œå…«åŒºå¹¶æ ¼å¼åŒ–æ—¶é—´
          timestamp=$(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M:%S%:z")
          
          # æ„å»ºé€šçŸ¥æ¶ˆæ¯
          message=$(cat <<EOF
          {
            "msgtype": "markdown",
            "markdown": {
              "title": "Home Assistant ç‰ˆæœ¬æ›´æ–°",
              "text": "ğŸš€ **æ›´æ–°æ—¶é—´: $timestamp**\n\n${{ steps.compare.outputs.change_summary }}"
            },
            "at": {
              "isAtAll": false
            }
          }
          EOF
          )
          
          # å‘é€é€šçŸ¥
          curl -s -X POST "${{ secrets.DINGTALK_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "$message"
          
          echo "Notification sent for version updates"